
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="NovelDownloader: A toolkit for downloading and processing novels.">
      
      
        <meta name="author" content="Saudade Z">
      
      
      
        <link rel="prev" href="../faloo_web/">
      
      
        <link rel="next" href="../parse_js_iife/">
      
      
        
      
      
      <link rel="icon" href="../../assets/logo.svg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Linovelib Web Analysis Notes - NovelDownloader</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#linovelib" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="NovelDownloader" class="md-header__button md-logo" aria-label="NovelDownloader" data-md-component="logo">
      
  <img src="../../assets/logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            NovelDownloader
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Linovelib Web Analysis Notes
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-hidden="true"  type="radio" name="__palette" id="__palette_1">
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/saudadez21/novel-downloader" title="Go to repository" class="md-source" data-md-component="source" target="_blank" rel="noopener">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    NovelDownloader
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../guide/installation/" class="md-tabs__link">
          
  
  
    
  
  Guide

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../supported-sites/" class="md-tabs__link">
          
  
  
    
  
  Supported Sites

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../reference/api-examples/" class="md-tabs__link">
          
  
  
    
  
  Reference

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../aes/" class="md-tabs__link">
          
  
  
    
  
  Notes

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../misc/todo/" class="md-tabs__link">
          
  
  
    
  
  Misc

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="NovelDownloader" class="md-nav__button md-logo" aria-label="NovelDownloader" data-md-component="logo">
      
  <img src="../../assets/logo.svg" alt="logo">

    </a>
    NovelDownloader
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/saudadez21/novel-downloader" title="Go to repository" class="md-source" data-md-component="source" target="_blank" rel="noopener">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    NovelDownloader
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Guide
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Guide
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Install
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/configuration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Configuration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/settings-reference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Settings Reference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/processors-reference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Processors Reference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/cli-examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CLI Usage
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/web-examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Web Usage
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/file-saving/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    File Saving
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/copy-cookies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Copy Cookies
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../supported-sites/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Supported Sites
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Supported Sites
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../supported-sites/tags/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tags
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/api-examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    API Examples
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/plugins/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Plugins
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Notes
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Notes
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../aes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AES Notes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../duokan_epub/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Duokan EPUB Notes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../faloo_web/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Faloo Web Notes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Linovelib Notes
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Linovelib Notes
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#202508" class="md-nav__link">
    <span class="md-ellipsis">
      
        2025/08 ~ ??? 混淆逻辑
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2025/08 ~ ??? 混淆逻辑">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pcthemejs" class="md-nav__link">
    <span class="md-ellipsis">
      
        一、pctheme.js 的正则替换映射
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chapterlogjs-seeded-fisheryates" class="md-nav__link">
    <span class="md-ellipsis">
      
        二、chapterlog.js 的段落打乱与恢复 (Seeded Fisher–Yates)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#202508_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        ??? ~ 2025/08 混淆逻辑
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="??? ~ 2025/08 混淆逻辑">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        一、混淆脚本与字体注入
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        二、字体渲染测试
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        三、空字形统计与判定
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        四、字体还原思路与结果
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      
        五、使用与还原
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../parse_js_iife/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    JS IIFE Parsing Notes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../qidian_app/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Qidian App Notes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../qidian_web/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Qidian Web Notes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xiguashuwu/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Xiguashuwu Notes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Misc
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Misc
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/todo/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    TODO
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#202508" class="md-nav__link">
    <span class="md-ellipsis">
      
        2025/08 ~ ??? 混淆逻辑
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2025/08 ~ ??? 混淆逻辑">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pcthemejs" class="md-nav__link">
    <span class="md-ellipsis">
      
        一、pctheme.js 的正则替换映射
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chapterlogjs-seeded-fisheryates" class="md-nav__link">
    <span class="md-ellipsis">
      
        二、chapterlog.js 的段落打乱与恢复 (Seeded Fisher–Yates)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#202508_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        ??? ~ 2025/08 混淆逻辑
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="??? ~ 2025/08 混淆逻辑">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        一、混淆脚本与字体注入
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        二、字体渲染测试
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        三、空字形统计与判定
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        四、字体还原思路与结果
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      
        五、使用与还原
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/saudadez21/novel-downloader/edit/main/docs/notes/linovelib.md" title="Edit this page" class="md-content__button md-icon" rel="edit noopener" target="_blank">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


<h1 id="linovelib">哔哩轻小说 (linovelib) 分析笔记<a class="headerlink" href="#linovelib" title="Permanent link">&para;</a></h1>
<p>创建日期: 2025/05/25</p>
<p>修改日期: 2025/10/06</p>
<h2 id="202508">2025/08 ~ ??? 混淆逻辑<a class="headerlink" href="#202508" title="Permanent link">&para;</a></h2>
<h3 id="pcthemejs">一、<code>pctheme.js</code> 的正则替换映射<a class="headerlink" href="#pcthemejs" title="Permanent link">&para;</a></h3>
<p><code>pctheme.js</code> 中包含形如 "链式 <code>replace(new RegExp(...) , '...')</code>" 的批量替换，约 100 对。</p>
<p>例如:</p>
<div class="highlight"><pre><span></span><code><span class="nb">eval</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span><span class="nx">a</span><span class="p">,</span><span class="nx">c</span><span class="p">,</span><span class="nx">k</span><span class="p">,</span><span class="nx">e</span><span class="p">,</span><span class="nx">r</span><span class="p">){</span><span class="nx">e</span><span class="o">=</span><span class="nb">String</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="s1">&#39;&#39;</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^/</span><span class="p">,</span><span class="nb">String</span><span class="p">)){</span><span class="k">while</span><span class="p">(</span><span class="nx">c</span><span class="o">--</span><span class="p">)</span><span class="nx">r</span><span class="p">[</span><span class="nx">c</span><span class="p">]</span><span class="o">=</span><span class="nx">k</span><span class="p">[</span><span class="nx">c</span><span class="p">]</span><span class="o">||</span><span class="nx">c</span><span class="p">;</span><span class="nx">k</span><span class="o">=</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="k">return</span><span class="w"> </span><span class="nx">r</span><span class="p">[</span><span class="nx">e</span><span class="p">]}];</span><span class="nx">e</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">return</span><span class="s1">&#39;\\w+&#39;</span><span class="p">};</span><span class="nx">c</span><span class="o">=</span><span class="mf">1</span><span class="p">};</span><span class="k">while</span><span class="p">(</span><span class="nx">c</span><span class="o">--</span><span class="p">)</span><span class="k">if</span><span class="p">(</span><span class="nx">k</span><span class="p">[</span><span class="nx">c</span><span class="p">])</span><span class="nx">p</span><span class="o">=</span><span class="nx">p</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">RegExp</span><span class="p">(</span><span class="s1">&#39;\\b&#39;</span><span class="o">+</span><span class="nx">e</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;\\b&#39;</span><span class="p">,</span><span class="s1">&#39;g&#39;</span><span class="p">),</span><span class="nx">k</span><span class="p">[</span><span class="nx">c</span><span class="p">]);</span><span class="k">return</span><span class="w"> </span><span class="nx">p</span><span class="p">}(</span><span class="s1">&#39;4=4.0(1 2(&quot;&quot;,&quot;3&quot;),&quot;的&quot;)...&#39;</span><span class="p">,</span><span class="mf">5</span><span class="p">,</span><span class="mf">5</span><span class="p">,</span><span class="s1">&#39;replace|new|RegExp|gi|k&#39;</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">),</span><span class="mf">0</span><span class="p">,{}));</span>
</code></pre></div>
<p>解混淆后本质为:</p>
<ul>
<li>对正文文本执行若干 <code>str.replace(new RegExp(SRC, 'gi'), DST)</code></li>
<li><code>SRC</code> 多为私有区或特殊部件字符 (如 <code></code>)，<code>DST</code> 为常用汉字 (如 <code>的</code>)</li>
</ul>
<p>示例:</p>
<div class="highlight"><pre><span></span><code><span class="nx">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">k</span>
<span class="w">  </span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;gi&quot;</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;的&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;gi&quot;</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;一&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;gi&quot;</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;是&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;gi&quot;</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;了&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;gi&quot;</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;我&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;gi&quot;</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;不&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;gi&quot;</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;人&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;gi&quot;</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;在&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;gi&quot;</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;他&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;gi&quot;</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;有&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;gi&quot;</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;这&quot;</span><span class="p">);</span>
</code></pre></div>
<p>处理方法:</p>
<p>解析 <code>pctheme.js</code> 文本，正则匹配 <code>new RegExp\(["'](.+?)["'],"gi"\)\s*,\s*["'](.+?)["']</code> 收集为 <code>map[SRC] = DST</code> 并保存为 json。</p>
<p>参考还原 (Python):</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="n">LINOVELIB_MAP_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/path/to/map.json&quot;</span><span class="p">)</span>
<span class="n">_PCTHEMA_MAP</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
    <span class="n">LINOVELIB_MAP_PATH</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
<span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_map_subst</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply PC theme character substitution to the input text.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_PCTHEMA_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">text</span><span class="p">)</span>
</code></pre></div>
<h3 id="chapterlogjs-seeded-fisheryates">二、<code>chapterlog.js</code> 的段落打乱与恢复 (Seeded Fisher–Yates)<a class="headerlink" href="#chapterlogjs-seeded-fisheryates" title="Permanent link">&para;</a></h3>
<p><code>chapterlog.js</code> 使用 <a href="https://github.com/javascript-obfuscator/javascript-obfuscator" target="_blank" rel="noopener"><code>javascript-obfuscator</code></a> 混淆，机制要点:</p>
<ol>
<li>仅处理 <code>#TextContent</code> 下非空 <code>&lt;p&gt;</code> 段落。</li>
<li>若段落数 &lt;= 20: 顺序不变。</li>
<li>若段落数 &gt; 20: 前 20 段固定，其余段按章节 ID 派生的种子进行 Fisher–Yates 打乱。</li>
<li>伪随机序列采用线性同余: <code>s = (s*9302 + 49397) % 233280</code>，选位 <code>j = floor(s/233280*(i+1))</code>。</li>
<li>种子 <code>seed = chapterId*127 + 235</code>。</li>
</ol>
<p>核心逻辑复原如下:</p>
<div class="highlight"><pre><span></span><code><span class="kd">var</span><span class="w"> </span><span class="nx">chapterId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ReadParams</span><span class="p">.</span><span class="nx">chapterid</span><span class="p">;</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">chapterId</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="kd">var</span><span class="w"> </span><span class="nx">textContainer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;#TextContent&quot;</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">textContainer</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="kd">var</span><span class="w"> </span><span class="nx">allNodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">textContainer</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">);</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">paragraphs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span><span class="w"> </span><span class="c1">// 收集非空 &lt;p&gt;</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">allNodes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">allNodes</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">nodeType</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">tagName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;p&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\s+/g</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">).</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">paragraphs</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="w"> </span><span class="nx">node</span><span class="o">:</span><span class="w"> </span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">idx</span><span class="o">:</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span><span class="w"> </span><span class="nx">paragraphCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">paragraphs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">paragraphCount</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">shuffle</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span><span class="w"> </span><span class="nx">seed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<span class="w">  </span><span class="nx">seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">seed</span><span class="p">);</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">len</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">seed</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">9302</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">49397</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mf">233280</span><span class="p">;</span><span class="w">           </span><span class="c1">// 线性同余伪随机</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">seed</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">233280</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">));</span><span class="w">     </span><span class="c1">// Fisher–Yates 选位</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span><span class="w"> </span><span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">array</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span><span class="w"> </span><span class="nx">array</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">tmp</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">array</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span><span class="w"> </span><span class="nx">seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">chapterId</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">127</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">235</span><span class="p">;</span><span class="w">            </span><span class="c1">// 种子派生</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">paragraphCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">20</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">fixed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="nx">rest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">paragraphCount</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">20</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">fixed</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">rest</span><span class="p">).</span><span class="nx">push</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
<span class="w">  </span><span class="nx">shuffle</span><span class="p">(</span><span class="nx">rest</span><span class="p">,</span><span class="w"> </span><span class="nx">seed</span><span class="p">);</span>
<span class="w">  </span><span class="nx">order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fixed</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">rest</span><span class="p">);</span><span class="w">                        </span><span class="c1">// 前 20 固定，其余打乱</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">paragraphCount</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="nx">order</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// 映射</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">reordered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">paragraphCount</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">reordered</span><span class="p">[</span><span class="nx">order</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">paragraphs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">node</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>参考还原 (Python):</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_chapterlog_order</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">cid</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the paragraph reordering index sequence used by /scripts/chapterlog.js.</span>

<span class="sd">    :param n: Total number of non-empty paragraphs in the chapter.</span>
<span class="sd">    :param cid: Chapter ID (used as the seed for the shuffle).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>

    <span class="n">fixed</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
    <span class="n">rest</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>

    <span class="c1"># Seeded Fisher-Yates</span>
    <span class="n">m</span> <span class="o">=</span> <span class="mi">233_280</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">9_302</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">49_397</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">cid</span> <span class="o">*</span> <span class="mi">127</span> <span class="o">+</span> <span class="mi">235</span>  <span class="c1"># seed</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span> <span class="n">a</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span> <span class="o">%</span> <span class="n">m</span>
        <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">//</span> <span class="n">m</span>
        <span class="n">rest</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rest</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">rest</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">rest</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">fixed</span> <span class="o">+</span> <span class="n">rest</span>

<span class="k">def</span><span class="w"> </span><span class="nf">restore_paragraphs</span><span class="p">(</span><span class="n">paragraphs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">cid</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">_chapterlog_order</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">paragraphs</span><span class="p">),</span> <span class="n">cid_int</span><span class="p">)</span>
    <span class="n">reordered_p</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">paragraphs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paragraphs</span><span class="p">):</span>
        <span class="n">reordered_p</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">p</span>
    <span class="k">return</span> <span class="n">reordered_p</span>
</code></pre></div>
<hr />
<h2 id="202508_1">??? ~ 2025/08 混淆逻辑<a class="headerlink" href="#202508_1" title="Permanent link">&para;</a></h2>
<blockquote>
<p>说明: 以下为 2025/08 之前的混淆方案，现已被替代。</p>
</blockquote>
<h3 id="_1">一、混淆脚本与字体注入<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h3>
<p>部分章节页面包含经混淆压缩的脚本，其作用是动态注入 <code>@font-face</code> 并将自定义字体应用到指定段落。还原后的核心逻辑如下:</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">sheet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">CSSStyleSheet</span><span class="p">();</span>
<span class="nx">sheet</span><span class="p">.</span><span class="nx">replaceSync</span><span class="p">(</span><span class="sb">`</span>
<span class="sb">  @font-face {</span>
<span class="sb">    font-family: read;</span>
<span class="sb">    font-display: block;</span>
<span class="sb">    src: url(&#39;/public/font/read.woff2&#39;) format(&#39;woff2&#39;),</span>
<span class="sb">         url(&#39;/public/font/read.ttf&#39;) format(&#39;truetype&#39;);</span>
<span class="sb">  }</span>
<span class="sb">  #TextContent p:nth-last-of-type(2) {</span>
<span class="sb">    font-family: &quot;read&quot; !important;</span>
<span class="sb">  }</span>
<span class="sb">`</span><span class="p">);</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">adoptedStyleSheets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">  </span><span class="p">...</span><span class="nb">document</span><span class="p">.</span><span class="nx">adoptedStyleSheets</span><span class="p">,</span>
<span class="w">  </span><span class="nx">sheet</span>
<span class="p">];</span>
</code></pre></div>
<p>页面对倒数第二个 <code>&lt;p&gt;</code> 应用自定义字体 <code>read</code>; 最后一个 <code>&lt;p&gt;</code> 恒为空行。与起点的做法相似，但此处字体文件固定，非按请求动态生成。</p>
<p>对应 CSS:</p>
<div class="highlight"><pre><span></span><code><span class="p">@</span><span class="k">font-face</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nt">font-family</span><span class="o">:</span><span class="w"> </span><span class="nt">read</span><span class="o">;</span>
<span class="w">  </span><span class="nt">font-display</span><span class="o">:</span><span class="w"> </span><span class="nt">block</span><span class="o">;</span>
<span class="w">  </span><span class="nt">src</span><span class="o">:</span><span class="w"> </span><span class="nt">url</span><span class="o">(</span><span class="s1">&#39;/public/font/read.woff2&#39;</span><span class="o">)</span><span class="w"> </span><span class="nt">format</span><span class="o">(</span><span class="s1">&#39;woff2&#39;</span><span class="o">),</span>
<span class="w">       </span><span class="nt">url</span><span class="o">(</span><span class="s1">&#39;/public/font/read.ttf&#39;</span><span class="o">)</span><span class="w"> </span><span class="nt">format</span><span class="o">(</span><span class="s1">&#39;truetype&#39;</span><span class="o">);</span>
<span class="p">}</span>
<span class="p">#</span><span class="nn">TextContent</span><span class="w"> </span><span class="nt">p</span><span class="p">:</span><span class="nd">nth-last-of-type</span><span class="o">(</span><span class="nt">2</span><span class="o">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">font-family</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;read&quot;</span><span class="w"> </span><span class="cp">!important</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_2">二、字体渲染测试<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>为验证该字体映射情况, 使用 <code>Pillow</code> 库对示例字符串进行渲染:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">textwrap</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageDraw</span><span class="p">,</span> <span class="n">ImageFont</span>

<span class="n">CELL_SIZE</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">FONT_SIZE</span> <span class="o">=</span> <span class="mi">52</span>
<span class="n">FONT_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;read.woff2&quot;</span>
<span class="n">TEXT_SAMPLE</span> <span class="o">=</span> <span class="s2">&quot;「床瑰蛾妹」&quot;</span>  <span class="c1"># 即使与全世界为敌</span>

<span class="k">def</span><span class="w"> </span><span class="nf">render_text</span><span class="p">(</span>
    <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">font</span><span class="p">:</span> <span class="n">ImageFont</span><span class="o">.</span><span class="n">FreeTypeFont</span><span class="p">,</span>
    <span class="n">cell_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">CELL_SIZE</span><span class="p">,</span>
    <span class="n">chars_per_line</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Render a string into a image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">chars_per_line</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>
    <span class="n">img_w</span> <span class="o">=</span> <span class="n">cell_size</span> <span class="o">*</span> <span class="n">chars_per_line</span>
    <span class="n">img_h</span> <span class="o">=</span> <span class="n">cell_size</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">img_w</span><span class="p">,</span> <span class="n">img_h</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">draw</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">col</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">cell_size</span>
            <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">row</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">cell_size</span>
            <span class="n">draw</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">ch</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">anchor</span><span class="o">=</span><span class="s2">&quot;mm&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">img</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">font</span> <span class="o">=</span> <span class="n">ImageFont</span><span class="o">.</span><span class="n">truetype</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">FONT_PATH</span><span class="p">),</span> <span class="n">FONT_SIZE</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">render_text</span><span class="p">(</span><span class="n">TEXT_SAMPLE</span><span class="p">,</span> <span class="n">font</span><span class="p">)</span>
    <span class="n">image</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p><img alt="font_sample" src="../../assets/images/linovelib_read_font_sample.png" /></p>
<p>观察可见:</p>
<p>部分字符渲染为空白, 如示例中所示。</p>
<p>页面编码形式通常表现为「两位 PUA 字符 + 一位汉字」的交替组合; 但 <code>read</code> 字体未为这些常见汉字嵌入字形，因此渲染为空。</p>
<h3 id="_3">三、空字形统计与判定<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p><code>read.ttf</code> 中存在大量 "映射存在但字形为空" 的条目，以 <code>ttx</code> 导出可见 (<code>ttx ./read.ttf</code>):</p>
<ul>
<li><code>cmap</code> 映射到诸如 <code>glyph07404</code></li>
<li><code>hmtx</code> 中对应 <code>width=0</code></li>
<li><code>glyf</code> 的 <code>TTGlyph</code> 不含轮廓</li>
</ul>
<p>示例：</p>
<div class="highlight"><pre><span></span><code>&lt;hmtx&gt;
  &lt;mtx name=&quot;glyph07404&quot; width=&quot;0&quot; lsb=&quot;0&quot;/&gt;
  &lt;mtx name=&quot;glyph07405&quot; width=&quot;0&quot; lsb=&quot;0&quot;/&gt;
...
&lt;cmap_format_4 ...&gt;
  &lt;map code=&quot;0x4e00&quot; name=&quot;glyph07404&quot;/&gt;
  &lt;map code=&quot;0x4e01&quot; name=&quot;glyph07405&quot;/&gt;
...
&lt;TTGlyph name=&quot;glyph07404&quot;/&gt;&lt;!-- contains no outline data --&gt;
&lt;TTGlyph name=&quot;glyph07405&quot;/&gt;&lt;!-- contains no outline data --&gt;
</code></pre></div>
<p>由此可见，<code>0x4e00</code> 和 <code>0x4e01</code>（即“ 一 ”、“ 丁 ”）虽在映射表中存在，但对应的字形数据为空，且宽度为 0，渲染时显示为空白。</p>
<p><strong>判定原则:</strong></p>
<ol>
<li><code>glyf</code> 中无轮廓</li>
<li><code>hmtx</code> 中水平宽度为 0</li>
</ol>
<p>满足任一条件即可认定为空字形。</p>
<p>示例统计 (基于 <code>fontTools</code>):</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fontTools.ttLib</span><span class="w"> </span><span class="kn">import</span> <span class="n">TTFont</span>

<span class="k">def</span><span class="w"> </span><span class="nf">count_blank_glyphs</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">font</span> <span class="o">=</span> <span class="n">TTFont</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">font</span><span class="o">.</span><span class="n">getBestCmap</span><span class="p">()</span>
    <span class="n">hmtx_table</span> <span class="o">=</span> <span class="n">font</span><span class="p">[</span><span class="s2">&quot;hmtx&quot;</span><span class="p">]</span>

    <span class="n">blank_chars</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">glyph_name</span> <span class="ow">in</span> <span class="n">cmap</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">width</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">hmtx_table</span><span class="p">[</span><span class="n">glyph_name</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">width</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">blank_chars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">blank_chars</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">blanks</span> <span class="o">=</span> <span class="n">count_blank_glyphs</span><span class="p">(</span><span class="s2">&quot;read.ttf&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;空字形数量: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">blanks</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<p>统计结果: 共有 <strong>3500</strong> 个空字形。</p>
<h3 id="_4">四、字体还原思路与结果<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>由于 <code>read.ttf</code>/<code>read.woff2</code> 地址固定，所有章节复用同一字体，无需逐章 OCR。</p>
<p>字体信息示例:</p>
<div class="highlight"><pre><span></span><code>字体名称: MI LANTING
版本: Version 2.3.3;GB Outside YS Regular
TrueType Outlines
</code></pre></div>
<p>由此可定位原始字体来源 (如 <code>MI LANTING</code>)。</p>
<p>对 <code>read.ttx</code> 的 <code>cmap</code> 观察可知混淆主要位于 PUA 区间 <code>0xE000</code> - <code>0xF8FE</code>。</p>
<p>先通过渲染检查是否是混淆的范围 (在此省略)</p>
<p>再测试确认该区间字符数:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">extract_font_charset</span><span class="p">(</span>
    <span class="n">font_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">lower_bound</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">upper_bound</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract the set of Unicode characters encoded by a TrueType/OpenType font.</span>

<span class="sd">    :param font_path: Path to a TTF/OTF font file.</span>
<span class="sd">    :param lower_bound: Inclusive lower bound of code points (e.g. 0x4E00).</span>
<span class="sd">    :param upper_bound: Inclusive upper bound of code points (e.g. 0x9FFF).</span>
<span class="sd">    :return: A set of Unicode characters present in the font&#39;s cmap within the specified range.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">TTFont</span><span class="p">(</span><span class="n">font_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">font_ttf</span><span class="p">:</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">font_ttf</span><span class="o">.</span><span class="n">getBestCmap</span><span class="p">()</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="n">charset</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">cp</span> <span class="ow">in</span> <span class="n">cmap</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">lower_bound</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cp</span> <span class="o">&lt;</span> <span class="n">lower_bound</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">upper_bound</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cp</span> <span class="o">&gt;</span> <span class="n">upper_bound</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">charset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">cp</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">charset</span>

<span class="n">ENCRYPTED_FROM</span> <span class="o">=</span> <span class="mh">0xE000</span>
<span class="n">ENCRYPTED_TO</span> <span class="o">=</span> <span class="mh">0xF8FE</span>

<span class="n">read_chars</span> <span class="o">=</span> <span class="n">extract_font_charset</span><span class="p">(</span><span class="s2">&quot;read.ttf&quot;</span><span class="p">,</span> <span class="n">ENCRYPTED_FROM</span><span class="p">,</span> <span class="n">ENCRYPTED_TO</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;共提取到 </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">read_chars</span><span class="p">)</span><span class="si">}</span><span class="s2"> 个字符&quot;</span><span class="p">)</span>
</code></pre></div>
<p>一共 3606 个字符</p>
<p>随后对 <code>read.ttx</code> 与 <code>MI LANTING.ttx</code> 进行字形级匹配还原。</p>
<p>直接 <code>O(n×m)</code> 全量比较在两侧均约 2.7 万字形时成本过高，故采用以下剪枝与加速:</p>
<ul>
<li>仅在 PUA 区间 (<code>0xE000</code> - <code>0xF8FE</code>) 匹配</li>
<li>利用空字形先验: 已知 <code>read</code> 中约 3500 个 "空字形" 在原字体中有真实字形，可优先匹配</li>
<li>基于字形组件与轮廓构建 <strong>规范化指纹</strong> 并哈希预筛</li>
<li>预筛失败再回退全量严格比较</li>
<li>未匹配项单独记录，后续人工复核</li>
</ul>
<p>经优化后，预估耗时由约 8 小时降至约 1 分钟 (环境相关)。</p>
<details>
<summary>核心脚本 (点击展开)</summary>

<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env python3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lxml</span><span class="w"> </span><span class="kn">import</span> <span class="n">etree</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lxml.etree</span><span class="w"> </span><span class="kn">import</span> <span class="n">_Element</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">lru_cache</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>

<span class="n">ENCRYPTED_FROM</span> <span class="o">=</span> <span class="mh">0xE000</span>
<span class="n">ENCRYPTED_TO</span>   <span class="o">=</span> <span class="mh">0xF8FE</span>

<span class="k">def</span><span class="w"> </span><span class="nf">load_ttx_glyphs</span><span class="p">(</span><span class="n">ttx_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_Element</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load TTGlyph elements: glyphName -&gt; TTGlyph Element&quot;&quot;&quot;</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">ttx_path</span><span class="p">)</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
    <span class="n">glyphs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_Element</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;.//TTGlyph&quot;</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">glyphs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span>
    <span class="k">return</span> <span class="n">glyphs</span>

<span class="k">def</span><span class="w"> </span><span class="nf">load_cmap_map</span><span class="p">(</span><span class="n">ttx_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build cmap: codepoint(int) -&gt; glyphName(str)&quot;&quot;&quot;</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">ttx_path</span><span class="p">)</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
    <span class="n">cmap_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">map_node</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;.//map&quot;</span><span class="p">):</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">map_node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;code&quot;</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">map_node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">code</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="k">if</span> <span class="n">code</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;0x&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="n">cmap_map</span><span class="p">[</span><span class="n">cp</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
    <span class="k">return</span> <span class="n">cmap_map</span>

<span class="k">def</span><span class="w"> </span><span class="nf">load_hmtx_widths</span><span class="p">(</span><span class="n">ttx_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read &lt;hmtx&gt;&lt;mtx name=... width=.../&gt; -&gt; glyphName -&gt; width(int)&quot;&quot;&quot;</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">ttx_path</span><span class="p">)</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
    <span class="n">widths</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">mtx</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;.//hmtx/mtx&quot;</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">mtx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">mtx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">w</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">widths</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">continue</span>
    <span class="k">return</span> <span class="n">widths</span>

<span class="k">def</span><span class="w"> </span><span class="nf">make_blank_checker</span><span class="p">(</span><span class="n">glyphs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_Element</span><span class="p">],</span> <span class="n">widths</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a callable is_blank(glyph_name) that memoizes:</span>
<span class="sd">      - True if no contour AND (no components OR all components are blank)</span>
<span class="sd">      - OR width == 0 (hmtx)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_is_blank</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">widths</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">glyphs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">g</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># missing -&gt; treat as blank to be safe</span>
        <span class="n">contours</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;contour&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">contours</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">comps</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;component&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">comps</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">:</span>
            <span class="n">child</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;glyphName&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">child</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_blank</span><span class="p">(</span><span class="n">child</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">_is_blank</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_compare_components_xml</span><span class="p">(</span><span class="n">comp_nodes_a</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">_Element</span><span class="p">],</span> <span class="n">comp_nodes_b</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">_Element</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Strict compare for &lt;component&gt; lists — exact equality on x,y,scalex,scaley.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">comp_nodes_a</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">comp_nodes_b</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">ca</span><span class="p">,</span> <span class="n">cb</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">comp_nodes_a</span><span class="p">,</span> <span class="n">comp_nodes_b</span><span class="p">):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ca</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dx&quot;</span><span class="p">)</span>
        <span class="n">ay</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ca</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dy&quot;</span><span class="p">)</span>
        <span class="n">bx</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">cb</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dx&quot;</span><span class="p">)</span>
        <span class="n">by</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">cb</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dy&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="o">!=</span> <span class="n">bx</span> <span class="ow">or</span> <span class="n">ay</span> <span class="o">!=</span> <span class="n">by</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">asx</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scalex&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ca</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scale&quot;</span><span class="p">)</span>
        <span class="n">asy</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scaley&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ca</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scaleY&quot;</span><span class="p">)</span>
        <span class="n">bsx</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scalex&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">cb</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scale&quot;</span><span class="p">)</span>
        <span class="n">bsy</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scaley&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">cb</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scaleY&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">asx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">bsx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">asx</span> <span class="o">!=</span> <span class="n">bsx</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">asy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">bsy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">asy</span> <span class="o">!=</span> <span class="n">bsy</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_contour_sig</span><span class="p">(</span><span class="n">c</span><span class="p">:</span> <span class="n">_Element</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s2">&quot;pt&quot;</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="n">on</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;on&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">);</span> <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">);</span> <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">);</span> <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">);</span> <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">on</span><span class="p">);</span> <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_compare_contours_xml</span><span class="p">(</span><span class="n">glyph_a</span><span class="p">:</span> <span class="n">_Element</span><span class="p">,</span> <span class="n">glyph_b</span><span class="p">:</span> <span class="n">_Element</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fast contour comparison by serialized point strings.&quot;&quot;&quot;</span>
    <span class="n">contours_a</span> <span class="o">=</span> <span class="n">glyph_a</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;contour&quot;</span><span class="p">)</span>
    <span class="n">contours_b</span> <span class="o">=</span> <span class="n">glyph_b</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;contour&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">contours_a</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">contours_b</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">ca</span><span class="p">,</span> <span class="n">cb</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">contours_a</span><span class="p">,</span> <span class="n">contours_b</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">_contour_sig</span><span class="p">(</span><span class="n">ca</span><span class="p">)</span> <span class="o">!=</span> <span class="n">_contour_sig</span><span class="p">(</span><span class="n">cb</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>

<span class="k">def</span><span class="w"> </span><span class="nf">compare_glyphs_ttx</span><span class="p">(</span>
    <span class="n">glyphs_a</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_Element</span><span class="p">],</span> <span class="n">name_a</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">glyphs_b</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_Element</span><span class="p">],</span> <span class="n">name_b</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Component comparison first; otherwise contour comparison.&quot;&quot;&quot;</span>
    <span class="n">ga</span> <span class="o">=</span> <span class="n">glyphs_a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name_a</span><span class="p">);</span> <span class="n">gb</span> <span class="o">=</span> <span class="n">glyphs_b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name_b</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ga</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">gb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">comps_a</span> <span class="o">=</span> <span class="n">ga</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;component&quot;</span><span class="p">)</span>
    <span class="n">comps_b</span> <span class="o">=</span> <span class="n">gb</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;component&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">comps_a</span> <span class="ow">and</span> <span class="n">comps_b</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_compare_components_xml</span><span class="p">(</span><span class="n">comps_a</span><span class="p">,</span> <span class="n">comps_b</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_compare_contours_xml</span><span class="p">(</span><span class="n">ga</span><span class="p">,</span> <span class="n">gb</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">glyph_fingerprint</span><span class="p">(</span><span class="n">elem</span><span class="p">:</span> <span class="n">_Element</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Name-agnostic fingerprint based on components transforms or contour points.&quot;&quot;&quot;</span>
    <span class="n">comps</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;component&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">comps</span><span class="p">:</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;C|&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">comps</span><span class="p">)),</span> <span class="s2">&quot;|&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">:</span>
            <span class="n">x</span>  <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dx&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="n">y</span>  <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dy&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="n">sx</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scalex&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scale&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="n">sy</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scaley&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scaleY&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
    <span class="n">contours</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;contour&quot;</span><span class="p">)</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;O|&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">contours</span><span class="p">)),</span> <span class="s2">&quot;|&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">cont</span> <span class="ow">in</span> <span class="n">contours</span><span class="p">:</span>
        <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_contour_sig</span><span class="p">(</span><span class="n">cont</span><span class="p">));</span> <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">glyph_hash</span><span class="p">(</span><span class="n">elem</span><span class="p">:</span> <span class="n">_Element</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">glyph_fingerprint</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="s2">&quot;ignore&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">is_disallowed_target</span><span class="p">(</span><span class="n">cp</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">ch</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">cp</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ch</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="c1"># PUA (BMP)</span>
    <span class="k">if</span> <span class="mh">0xE000</span> <span class="o">&lt;=</span> <span class="n">cp</span> <span class="o">&lt;=</span> <span class="mh">0xF8FF</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>

<span class="k">def</span><span class="w"> </span><span class="nf">build_mapping_from_ttx</span><span class="p">(</span><span class="n">ttx_encrypted</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ttx_normal</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">]]:</span>
    <span class="n">glyphs_enc</span>  <span class="o">=</span> <span class="n">load_ttx_glyphs</span><span class="p">(</span><span class="n">ttx_encrypted</span><span class="p">)</span>
    <span class="n">glyphs_norm</span> <span class="o">=</span> <span class="n">load_ttx_glyphs</span><span class="p">(</span><span class="n">ttx_normal</span><span class="p">)</span>

    <span class="n">cmap_enc</span>    <span class="o">=</span> <span class="n">load_cmap_map</span><span class="p">(</span><span class="n">ttx_encrypted</span><span class="p">)</span>
    <span class="n">cmap_norm</span>   <span class="o">=</span> <span class="n">load_cmap_map</span><span class="p">(</span><span class="n">ttx_normal</span><span class="p">)</span>

    <span class="n">widths_enc</span>  <span class="o">=</span> <span class="n">load_hmtx_widths</span><span class="p">(</span><span class="n">ttx_encrypted</span><span class="p">)</span>
    <span class="n">widths_norm</span> <span class="o">=</span> <span class="n">load_hmtx_widths</span><span class="p">(</span><span class="n">ttx_normal</span><span class="p">)</span>

    <span class="n">is_blank_enc</span>  <span class="o">=</span> <span class="n">make_blank_checker</span><span class="p">(</span><span class="n">glyphs_enc</span><span class="p">,</span> <span class="n">widths_enc</span><span class="p">)</span>
    <span class="n">is_blank_norm</span> <span class="o">=</span> <span class="n">make_blank_checker</span><span class="p">(</span><span class="n">glyphs_norm</span><span class="p">,</span> <span class="n">widths_norm</span><span class="p">)</span>

    <span class="n">enc_all</span> <span class="o">=</span> <span class="p">[(</span><span class="n">cp</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">cp</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">cmap_enc</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">ENCRYPTED_FROM</span> <span class="o">&lt;=</span> <span class="n">cp</span> <span class="o">&lt;=</span> <span class="n">ENCRYPTED_TO</span><span class="p">]</span>

    <span class="n">encrypted_items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">enc_all</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">is_blank_enc</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="n">hash_index</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">cp_n</span><span class="p">,</span> <span class="n">gname_n</span> <span class="ow">in</span> <span class="n">cmap_norm</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">is_disallowed_target</span><span class="p">(</span><span class="n">cp_n</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">is_blank_norm</span><span class="p">(</span><span class="n">gname_n</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">glyphs_norm</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gname_n</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">g</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">glyph_hash</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
        <span class="n">hash_index</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cp_n</span><span class="p">,</span> <span class="n">gname_n</span><span class="p">))</span>

    <span class="n">mapping</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">unmatched</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">cp_s</span><span class="p">,</span> <span class="n">gname_s</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">encrypted_items</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;encrypted&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;glyph&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">is_blank_enc</span><span class="p">(</span><span class="n">gname_s</span><span class="p">):</span>
            <span class="n">unmatched</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">cp_s</span><span class="p">,</span> <span class="n">gname_s</span><span class="p">])</span>
            <span class="k">continue</span>

        <span class="n">g_enc</span> <span class="o">=</span> <span class="n">glyphs_enc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gname_s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">g_enc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">unmatched</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">cp_s</span><span class="p">,</span> <span class="n">gname_s</span><span class="p">])</span>
            <span class="k">continue</span>

        <span class="n">h</span> <span class="o">=</span> <span class="n">glyph_hash</span><span class="p">(</span><span class="n">g_enc</span><span class="p">)</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="n">hash_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">matched</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">cp_n</span><span class="p">,</span> <span class="n">gname_n</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">compare_glyphs_ttx</span><span class="p">(</span><span class="n">glyphs_enc</span><span class="p">,</span> <span class="n">gname_s</span><span class="p">,</span> <span class="n">glyphs_norm</span><span class="p">,</span> <span class="n">gname_n</span><span class="p">):</span>
                <span class="n">mapping</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">u</span><span class="si">{</span><span class="n">cp_s</span><span class="si">:</span><span class="s2">04x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">cp_n</span><span class="p">)</span>
                <span class="n">matched</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cp_n</span><span class="p">,</span> <span class="n">gname_n</span> <span class="ow">in</span> <span class="n">cmap_norm</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">is_disallowed_target</span><span class="p">(</span><span class="n">cp_n</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">is_blank_norm</span><span class="p">(</span><span class="n">gname_n</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">compare_glyphs_ttx</span><span class="p">(</span><span class="n">glyphs_enc</span><span class="p">,</span> <span class="n">gname_s</span><span class="p">,</span> <span class="n">glyphs_norm</span><span class="p">,</span> <span class="n">gname_n</span><span class="p">):</span>
                    <span class="n">mapping</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">u</span><span class="si">{</span><span class="n">cp_s</span><span class="si">:</span><span class="s2">04x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">cp_n</span><span class="p">)</span>
                    <span class="n">matched</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>
            <span class="n">unmatched</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">cp_s</span><span class="p">,</span> <span class="n">gname_s</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">unmatched</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">ttx_enc</span>  <span class="o">=</span> <span class="s2">&quot;read.ttx&quot;</span>
    <span class="n">ttx_norm</span> <span class="o">=</span> <span class="s2">&quot;MI LANTING.ttx&quot;</span>

    <span class="n">mapping</span><span class="p">,</span> <span class="n">unmatched</span> <span class="o">=</span> <span class="n">build_mapping_from_ttx</span><span class="p">(</span><span class="n">ttx_enc</span><span class="p">,</span> <span class="n">ttx_norm</span><span class="p">)</span>

    <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;mapping_from_ttx.json&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;unmatched_from_ttx.json&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">unmatched</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
</code></pre></div>

</details>

<p><strong>匹配结果与验证</strong></p>
<p>经过完整比对后，初步得到 <strong>3513</strong> 对映射关系，并有 <strong>93</strong> 项未找到对应字形。</p>
<p>随后将这 <strong>93 项</strong> 分别通过 HTML 对照方式，用 <code>read.ttf</code> 与原字体 (<code>MI LANTING.ttf</code>) 同时渲染同一段字符，人工对比结果如下:</p>
<ul>
<li>其中 <strong>91 项</strong> 实际上是正常可见字符 (并非混淆映射目标)</li>
<li>仅有 <strong>2 项</strong> 确认为真实的映射缺口</li>
</ul>
<p>这两项缺口手动补全如下:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;\uf63b&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;啰&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;\ue8c0&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;瞭&quot;</span>
<span class="p">}</span>
</code></pre></div>
<p>补全后，映射总数达到 <strong>3515</strong> 对。</p>
<p><strong>与空字形对比</strong></p>
<p>由于此前在 <code>read.ttf</code> 中统计得到 <strong>3500</strong> 个空字形 (即 <code>width=0</code> 且无轮廓)，两者数量非常接近，因此对两集合进行交叉比对:</p>
<ul>
<li>映射表的 value 集合与空字形集合之间，<strong>空字形集合是映射值的子集</strong>。</li>
<li>仅多出 <strong>15 个额外字符</strong>，这些字符全部为<strong>符号类误匹配</strong>，即虽然图形结构相似，但并非常用汉字。</li>
</ul>
<p>这些误匹配的字符如下:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;\ue7c7&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ḿ&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;\ue7c8&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ǹ&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;\ue7e7&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;〾&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;\ue7e8&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;⿰&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;\ue7e9&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;⿱&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;\ue7ea&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;⿲&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;\ue7eb&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;⿳&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;\ue7ec&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;⿴&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;\ue7ed&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;⿵&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;\ue7ee&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;⿶&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;\ue7ef&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;⿷&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;\ue7f0&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;⿸&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;\ue7f1&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;⿹&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;\ue7f2&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;⿺&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;\ue7f3&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;⿻&quot;</span>
<span class="p">}</span>
</code></pre></div>
<p>这些字符属于 Unicode 的部件或注音符号区，而非 CJK 统一汉字。</p>
<p>最终稳定为 <strong>3500</strong> 对一一对应。</p>
<h3 id="_5">五、使用与还原<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>保存一份映射表 JSON。使用时:</p>
<ol>
<li>先读取映射表并取其前 3500 个值构成空白集合</li>
<li>对混淆段落：先剔除空白字符，再按映射表替换</li>
</ol>
<p>示例:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">islice</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="n">LINOVELIB_FONT_MAP_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/path/to/map.json&quot;</span><span class="p">)</span>
<span class="n">_FONT_MAP</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
    <span class="n">LINOVELIB_FONT_MAP_PATH</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">_BLANK_SET</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">islice</span><span class="p">(</span><span class="n">_FONT_MAP</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="mi">3500</span><span class="p">))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_apply_font_map</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply font mapping to the input text, skipping characters in blank set.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_FONT_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">text</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_BLANK_SET</span><span class="p">)</span>
</code></pre></div>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.tabs", "navigation.top", "navigation.sections", "navigation.indexes", "search.highlight", "search.suggest", "content.code.copy", "content.action.edit", "toc.follow"], "search": "../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>